name: Handle CodeQL Scan Results

on:
  workflow_run:
    workflows: ["CodeQL"]
    # workflows: ["CodeQL test"]
    types:
      - completed
      

jobs:
  handle_codeql_scan:
    runs-on: ubuntu-latest
    # if: ${{ github.event.workflow_run.conclusion == 'success' && toJSON(github.event.workflow_run.pull_requests) != '[]' }}
    if: ${{ github.event.workflow_run.conclusion == 'success' && contains(github.event.workflow_run.head_branch,'refs/pull') }}
    permissions:
      pull-requests: write
      security-events: write
      statuses: write
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: 
        run: |
          
          echo "github.event.workflow_run.head_branch = " ${{ github.event.workflow_run.head_branch }}
          echo "contains(github.event.workflow_run.head_branch,'refs/pull') = " ${{ contains(github.event.workflow_run.head_branch,'refs/pull') }}
          echo $(curl --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' -s ${{github.event.workflow_run.repository.url}}/pulls/50 | jq -r '.head.ref')

          env
        shell: bash -l {0}
      - uses: mobb-dev/codeql-mobb-fixer-action@main
        with:
          mobb-api-token: ${{ secrets.MOBB_API_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
